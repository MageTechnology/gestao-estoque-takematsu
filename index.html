<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque Rápido</title>
    <!-- Carregando o Tailwind CSS para um design moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importando um ícone para a página -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .btn-principal {
            background-color: #10b981; color: white; font-weight: bold;
            padding: 1rem; border-radius: 0.75rem; text-align: center;
            width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-principal:hover { background-color: #059669; }
        .input-field {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem;
            border: 1px solid #d1d5db; background-color: white;
        }
        .input-field:disabled { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        #resultados-busca > div {
            padding: 0.75rem; border-bottom: 1px solid #e5e7eb; cursor: pointer;
        }
        #resultados-busca > div:hover { background-color: #f9fafb; }
        #resultados-busca > div:last-child { border-bottom: none; }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto max-w-lg p-4 min-h-screen flex flex-col items-center justify-center">
        
        <header class="text-center mb-8">
            <i class="fas-solid fa-boxes-stacked text-4xl text-gray-700 mb-2"></i>
            <h1 class="text-3xl font-bold text-gray-800">Contagem de Estoque Takematsu</h1>
            <p class="text-gray-500">Busque ou selecione o ingrediente para atualizar.</p>
        </header>

        <main class="w-full bg-white p-6 rounded-2xl shadow-lg space-y-4">

            <!-- MÉTODOS DE SELEÇÃO -->
            <div>
                <label for="busca-ingrediente" class="block text-sm font-medium text-gray-700 mb-1">1. Busque pelo Ingrediente</label>
                <div class="relative">
                    <input type="text" id="busca-ingrediente" class="input-field pl-10" placeholder="Ex: Salmão, Coca-cola..." oninput="buscarProdutos()">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="resultados-busca" class="mt-1 bg-white border rounded-md max-h-48 overflow-y-auto absolute w-[calc(100%-3rem)] z-10"></div>
            </div>

            <div class="text-center text-sm text-gray-400">ou selecione abaixo</div>

            <div>
                <label for="categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                <select id="categoria" class="input-field" onchange="filtrarIngredientesPorCategoria()">
                    <option value="">-- Carregando... --</option>
                </select>
            </div>
            <div>
                <label for="ingrediente" class="block text-sm font-medium text-gray-700 mb-1">Ingrediente</label>
                <select id="ingrediente" class="input-field" onchange="selecionarProdutoPeloDropdown()">
                    <option value="">-- Escolha uma categoria --</option>
                </select>
            </div>
            
            <!-- CAMPO DE QUANTIDADE (aparece após selecionar) -->
            <div id="passo-quantidade" class="hidden transition-all space-y-2 pt-4 border-t">
                <div class="flex justify-between items-center">
                    <label for="quantidade" class="block font-medium text-gray-800">2. Informe a Nova Quantidade (<span id="unidade-medida" class="font-bold"></span>)</label>
                    <button onclick="resetarFormulario()" class="text-xs text-blue-600 hover:underline">Trocar item</button>
                </div>
                <input type="number" id="quantidade" class="input-field text-2xl text-center font-bold" placeholder="0.00">
            </div>

            <!-- Botão de Ação -->
            <div class="pt-4">
                <button id="btn-atualizar" class="btn-principal opacity-50" disabled>
                    <i class="fas fa-paper-plane mr-2"></i> Enviar Atualização
                </button>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-gray-400">
            <p>Sistema de Automação de Estoque</p>
        </footer>

    </div>

    <script>
        let todosOsProdutos = [];
        let produtosPorCategoria = {};
        let produtoSelecionado = null;

        async function carregarDadosDaPlanilha() {
            const urlPlanilha = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwgXDxiy8_P5IjRrpEtytlFww9kb3tUm81dMHnlgYGt7dmVx1W6nArmytUtD9xkSPcypuaO9B6-HoH/pub?gid=877069221&single=true&output=csv';

            try {
                const response = await fetch(`${urlPlanilha}&t=${new Date().getTime()}`);
                const dataCSV = await response.text();
                
                const linhas = dataCSV.trim().split('\n');
                let headerRowIndex = linhas.findIndex(l => l.toUpperCase().includes('INGREDIENTES') && l.toUpperCase().includes('CATEGORIA'));
                if (headerRowIndex === -1) throw new Error("Cabeçalho não encontrado.");

                linhas.splice(0, headerRowIndex);
                const cabecalho = linhas.shift().split(',');

                const cleanHeader = h => h.trim().replace(/"/g, '').toUpperCase();
                const idxIngrediente = cabecalho.findIndex(h => cleanHeader(h) === 'INGREDIENTES');
                const idxCategoria = cabecalho.findIndex(h => cleanHeader(h) === 'CATEGORIA');
                const idxUnidade = cabecalho.findIndex(h => cleanHeader(h) === 'UND DE MEDIDA');

                if ([idxIngrediente, idxCategoria, idxUnidade].includes(-1)) throw new Error("Colunas essenciais não encontradas.");

                linhas.forEach(linha => {
                    const colunas = linha.split(',');
                    const cleanCol = i => colunas[i] ? colunas[i].trim().replace(/"/g, '') : '';
                    const nome = cleanCol(idxIngrediente);
                    const categoria = cleanCol(idxCategoria);
                    const unidade = cleanCol(idxUnidade);

                    if (nome && categoria) {
                        todosOsProdutos.push({ nome, categoria, unidade });
                        if (!produtosPorCategoria[categoria]) {
                            produtosPorCategoria[categoria] = [];
                        }
                        produtosPorCategoria[categoria].push({ nome, unidade });
                    }
                });
                
                popularCategorias();
                document.getElementById('busca-ingrediente').placeholder = `Busque em ${todosOsProdutos.length} produtos...`;
            } catch (error) {
                console.error('Erro ao carregar dados da planilha:', error);
                alert(`Não foi possível carregar os dados da planilha: ${error.message}`);
            }
        }

        function popularCategorias() {
            const selectCategoria = document.getElementById('categoria');
            selectCategoria.innerHTML = '<option value="">-- Escolha uma categoria --</option>';
            Object.keys(produtosPorCategoria).sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectCategoria.appendChild(option);
            });
        }

        function buscarProdutos() {
            const termoBusca = document.getElementById('busca-ingrediente').value.toLowerCase();
            const divResultados = document.getElementById('resultados-busca');
            divResultados.innerHTML = '';
            if (termoBusca.length < 2) return;

            const resultados = todosOsProdutos.filter(p => p.nome.toLowerCase().includes(termoBusca)).slice(0, 5);
            resultados.forEach(produto => {
                const itemDiv = document.createElement('div');
                itemDiv.innerHTML = `<strong>${produto.nome}</strong> <span class="text-xs text-gray-500">(${produto.categoria})</span>`;
                itemDiv.onclick = () => selecionarProduto(produto);
                divResultados.appendChild(itemDiv);
            });
        }

        function filtrarIngredientesPorCategoria() {
            const categoriaSel = document.getElementById('categoria').value;
            const selectIngrediente = document.getElementById('ingrediente');
            selectIngrediente.innerHTML = '<option value="">-- Escolha um ingrediente --</option>';
            if (categoriaSel && produtosPorCategoria[categoriaSel]) {
                produtosPorCategoria[categoriaSel].forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.nome;
                    option.textContent = prod.nome;
                    selectIngrediente.appendChild(option);
                });
            }
        }
        
        function selecionarProdutoPeloDropdown() {
            const nomeProduto = document.getElementById('ingrediente').value;
            if (!nomeProduto) return;
            const produto = todosOsProdutos.find(p => p.nome === nomeProduto);
            if (produto) selecionarProduto(produto);
        }

        function selecionarProduto(produto) {
            produtoSelecionado = produto;
            
            // Sincroniza e trava os campos
            document.getElementById('busca-ingrediente').value = produto.nome;
            document.getElementById('busca-ingrediente').disabled = true;
            document.getElementById('categoria').value = produto.categoria;
            document.getElementById('categoria').disabled = true;
            filtrarIngredientesPorCategoria(); // Popula o dropdown de ingredientes
            document.getElementById('ingrediente').value = produto.nome;
            document.getElementById('ingrediente').disabled = true;
            
            // Mostra o campo de quantidade
            document.getElementById('resultados-busca').innerHTML = '';
            document.getElementById('passo-quantidade').classList.remove('hidden');
            document.getElementById('unidade-medida').textContent = produto.unidade;
            document.getElementById('quantidade').focus();
            
            document.getElementById('btn-atualizar').disabled = false;
            document.getElementById('btn-atualizar').classList.remove('opacity-50');
        }
        
        function resetarFormulario() {
            produtoSelecionado = null;
            
            // Limpa e habilita os campos
            document.getElementById('busca-ingrediente').value = '';
            document.getElementById('busca-ingrediente').disabled = false;
            document.getElementById('categoria').value = '';
            document.getElementById('categoria').disabled = false;
            document.getElementById('ingrediente').innerHTML = '<option value="">-- Escolha uma categoria --</option>';
            document.getElementById('ingrediente').disabled = false;
            
            // Esconde a quantidade
            document.getElementById('passo-quantidade').classList.add('hidden');
            document.getElementById('quantidade').value = '';
            
            const btnAtualizar = document.getElementById('btn-atualizar');
            btnAtualizar.disabled = true;
            btnAtualizar.classList.add('opacity-50');
            
            document.getElementById('busca-ingrediente').focus();
        }

        document.getElementById('btn-atualizar').addEventListener('click', async () => {
            const quantidade = document.getElementById('quantidade').value;
            if (!produtoSelecionado || quantidade === '') {
                alert('Por favor, informe a quantidade!');
                return;
            }

            // Desabilita o botão para evitar múltiplos envios
            const btn = document.getElementById('btn-atualizar');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Enviando...';

            try {
                const response = await fetch('https://webhookn8n.mage.technology/webhook/estoque', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ingrediente: produtoSelecionado.nome,
                        categoria: produtoSelecionado.categoria,
                        unidade: produtoSelecionado.unidade,
                        quantidade: quantidade
                    })
                });

                if (response.ok) {
                    alert('Atualização enviada com sucesso!');
                    resetarFormulario();
                } else {
                    alert('Erro ao enviar atualização. Tente novamente.');
                }
            } catch (error) {
                alert('Erro de conexão. Tente novamente.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Enviar Atualização';
            }
        });

        window.onload = carregarDadosDaPlanilha;
    </script>
</body>
</html>
